<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MASTER ADMIN - SRE Hub</title>
    <style>
        /* --- DYNAMIC COLOR VARIABLES --- */
        :root {
            --c1: 227, 0, 15;   /* Red Default */
            --c2: 0, 40, 85;    /* Blue Default */
            --c3: 255, 215, 0;  /* Yellow Default */
        }

        body { background: #fdfdfd; color: #000; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-transform: uppercase; overflow-x: hidden; position: relative; transition: background 0.3s; }
        
        /* --- GLOBE BACKGROUND --- */
        #globe-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0; pointer-events: none; opacity: 0.15;
        }

        /* --- INTRO & LOGIN SCREENS --- */
        #intro-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ffffff; z-index: 9999999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; color: #000;
        }
        #intro-screen img { max-width: 200px; margin-bottom: 30px; }
        #intro-screen h1 { font-size: 20px; letter-spacing: 5px; margin: 0; font-weight: 900; }
        #intro-loader { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 9999998; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; color: #000;
        }
        .login-box { border: 3px solid #000; padding: 40px; width: 360px; text-align: center; background: #fff; box-shadow: 0 15px 50px rgba(0,0,0,0.1); position: relative; z-index: 10000000; }
        .login-box h1 { font-size: 18px; letter-spacing: 4px; margin-bottom: 25px; }
        
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; outline: none; font-size: 14px; text-transform: none; text-align: center; box-sizing: border-box; font-weight: bold; }
        .auth-input:focus { border-color: #000; }
        
        .code-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 3px solid #000; font-size: 28px; text-align: center; letter-spacing: 15px; outline: none; font-family: monospace; background: #f9f9f9; box-sizing: border-box; }

        /* --- MAIN UI LAYOUT --- */
        .master-header { text-align: center; padding: 30px 0; border-bottom: 1px solid #eee; background: rgba(255,255,255,0.9); position: relative; z-index: 1; }
        .master-header img { height: 100px; margin-bottom: 10px; }
        .master-header h1 { font-size: 14px; letter-spacing: 10px; margin: 0; color: #000; }

        .container { max-width: 1300px; margin: 0 auto; padding: 25px; position: relative; z-index: 1; display: none; } /* HIDDEN UNTIL LOGGED IN */
        .card { background: rgba(255,255,255,0.95); border: 1px solid #eee; padding: 25px; backdrop-filter: blur(5px); margin-bottom: 20px; transition: 0.2s; }
        .card:hover { border-color: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        
        .section-title { font-size: 12px; letter-spacing: 4px; font-weight: 900; margin: 40px 0 20px 0; border-left: 5px solid #000; padding-left: 15px; background: rgba(255,255,255,0.8); display: inline-block; padding-right: 15px;}
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        h2 { font-size: 10px; color: #999; margin: 0 0 15px 0; letter-spacing: 2px; }

        /* --- BUTTONS & INPUTS --- */
        .btn { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #000; background: #fff; color: #000; font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s; text-transform: uppercase; }
        .btn:hover { background: #000; color: #fff; }
        .btn.black { background: #000; color: #fff; }
        .btn.red { border-color: #E3000F; color: #E3000F; }
        .btn.red:hover { background: #E3000F; color: #fff; }
        .btn.green { border-color: #2ecc71; color: #2ecc71; }
        .btn.green:hover { background: #2ecc71; color: #fff; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; font-size: 12px; box-sizing: border-box; outline: none; background: rgba(255,255,255,0.9); font-family: sans-serif; }
        .flex-row { display: flex; gap: 10px; align-items: center; }

        /* --- NETWORK TABLE --- */
        table.net-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 12px; }
        table.net-table th { border-bottom: 2px solid #000; padding-bottom: 10px; text-align: left; color: #999; }
        table.net-table td { padding: 12px 0; border-bottom: 1px solid #eee; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

        /* --- SOUNDCLOUD CLEAN BLACK RIM --- */
        .admin-art-wrapper { padding: 2px; border-radius: 6px; background: #000; border: 2px solid #000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* --- DARK MODE --- */
        body.dark-mode { background: #111; color: #eee; }
        body.dark-mode .master-header { background: rgba(17,17,17,0.9); border-bottom: 1px solid #333; }
        body.dark-mode .master-header h1 { color: #eee; }
        body.dark-mode .card { background: rgba(30,30,30,0.95); border-color: #444; color: #eee; }
        body.dark-mode .section-title { background: rgba(17,17,17,0.8); color: #fff; border-left-color: #fff; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #333; color: #eee; border-color: #555; }
        body.dark-mode .btn { background: #333; color: #eee; border-color: #555; }
        body.dark-mode .btn:hover { background: #eee; color: #111; }
        body.dark-mode .btn.black { background: #eee; color: #111; }
        body.dark-mode table.net-table th { border-bottom-color: #555; color: #bbb; }
        body.dark-mode table.net-table td { border-bottom-color: #333; }

        /* CUSTOM RANGE SLIDER */
        input[type=range] { -webkit-appearance: none; background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; outline: none; border: none; margin: 0; padding: 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #fff; cursor: pointer; border: 2px solid #000; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <canvas id="globe-canvas"></canvas>

    <div id="intro-screen">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>ADMIN INITIALIZING</h1>
        <div id="intro-loader"></div>
        <div style="font-family: monospace; font-size: 12px; color: #666;">Connecting to Cloud Vault...</div>
    </div>
    <script>
        setTimeout(() => {
            const intro = document.getElementById('intro-screen');
            if(intro) { intro.style.opacity = '0'; setTimeout(() => intro.style.display = 'none', 500); }
        }, 2500);
    </script>

    <div id="login-screen">
        <div class="login-box">
            <h1>SYSTEM ACCESS</h1>
            
            <div id="auth-stage-1">
                <p style="font-size: 10px; margin-bottom: 20px; color: #666; letter-spacing: 2px; font-weight: bold;">ENTER CLOUD CREDENTIALS</p>
                <input type="text" id="logUser" class="auth-input" placeholder="USERNAME (e.g. Admin)">
                <input type="password" id="logPass" class="auth-input" placeholder="PASSWORD">
                <button class="btn black" style="padding: 15px; font-size: 13px;" onclick="checkCloudCredentials()">AUTHENTICATE</button>
            </div>

            <div id="auth-stage-2" style="display: none;">
                <p style="font-size: 11px; margin-bottom: 20px; color: #E3000F; font-weight: 900; letter-spacing: 2px;">CREDENTIALS ACCEPTED.<br>ENTER SECURE VAULT CODE.</p>
                <input type="password" id="accessCode" class="code-input" maxlength="6" placeholder="******">
                <button class="btn black" style="padding:15px; font-size: 13px;" onclick="verifySecretCode()">UNLOCK COMMAND CENTER</button>
            </div>
        </div>
    </div>

    <div class="master-header">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>SRE Master Hub Admin</h1>
    </div>

    <div class="container" id="main-ui">
        
        <div class="card" style="display:flex; justify-content: space-between; align-items: center; border: 2px solid #000; padding: 15px 25px;">
            <div class="flex-row">
                <span style="font-size: 11px; font-weight: 900;">COMMAND TARGET:</span>
                <select id="target-select" style="margin:0; width: 250px;"><option value="ALL">BROADCAST TO ALL SCREENS</option></select>
                <button class="btn black" style="margin:0; width:auto;" onclick="sendCommand('toggle_id')">TOGGLE SCREEN IDs</button>
            </div>
            <div class="flex-row">
                <button class="btn" style="margin:0; width:auto;" onclick="document.body.classList.toggle('dark-mode')">DARK MODE</button>
                <button class="btn red" style="margin:0; width:auto;" onclick="location.reload()">LOCK SYSTEM</button>
            </div>
        </div>

        <div class="section-title">NETWORK DASHBOARD (LIVE)</div>
        <div class="card" style="border: 2px solid #1f6feb;">
            <table class="net-table">
                <thead><tr><th>SCREEN ID</th><th>STATUS</th><th>LATENCY</th><th>UPTIME</th><th>ACTIONS</th></tr></thead>
                <tbody id="network-body"></tbody>
            </table>
        </div>

        <div class="section-title">NUCLEAR CONTROL CENTER</div>
        <div class="grid">
            <div class="card" style="border-top: 5px solid #2ecc71;">
                <h2>RESETS & CLEARS</h2>
                <button class="btn green" onclick="clearMedia()">STOP ALL OVERLAYS & AUDIO</button>
                <button class="btn green" onclick="sendCommand('clear_fx')">REMOVE VISUAL FX</button>
                <button class="btn green" onclick="sendCommand('ticker', '')">REVERT TO DR NEWS</button>
                <button class="btn green" onclick="sendCommand('reset_trains')">NORMALIZE TRAINS</button>
            </div>
            <div class="card" style="border-top: 5px solid #E3000F;">
                <h2>EMERGENCY OVERRIDE</h2>
                <button class="btn red" onclick="sendCommand('soft_reset')">SOFT REBOOT (KEEPS AUDIO)</button>
                <button class="btn black" onclick="sendCommand('reset')">HARD SYSTEM REBOOT</button>
                <button class="btn black" onclick="sendCommand('blackout')">FORCE TOTAL BLACKOUT</button>
                <button class="btn black" onclick="sendCommand('kick', 'ALL')">KICK ALL SCREENS</button>
            </div>
        </div>

        <div class="section-title">TRAIN BOARD MANAGEMENT</div>
        <div class="card">
            <h2>ADD, DELETE, AND EDIT LIVE TRAINS</h2>
            <div id="train-editor"></div>
            <div class="flex-row" style="margin-top:20px;">
                <button class="btn black" style="width:auto;" onclick="addNewTrain()">+ ADD NEW TRAIN</button>
                <button class="btn green" style="width:auto; border:none;" onclick="syncTrainBoard()">SAVE & PUSH TO SCREENS</button>
                <button class="btn red" style="width:auto; border:none; margin-left:auto;" onclick="cancelAllTrains()">CANCEL ALL TRAINS</button>
            </div>
        </div>

        <div class="section-title">GLOBAL SRE CONTROLS</div>
        <div class="grid">
            <div class="card">
                <h2>TICKER & BROADCAST</h2>
                <input type="text" id="tickInput" placeholder="Override news feed...">
                <button class="btn black" onclick="sendCommand('ticker', document.getElementById('tickInput').value)">SEND HEADLINE</button>
                <button class="btn red" style="margin-top:10px" onclick="sendCommand('status', 'PREMIERE NU')">SET LIVE STATUS</button>
                <button class="btn" onclick="sendCommand('status', 'KLAR')">RESET STATUS</button>
            </div>
            
            <div class="card">
                <h2>GLOBAL TRAIN STATUS</h2>
                <div class="flex-row">
                    <input type="number" id="dInput" placeholder="Min" style="flex:1">
                    <button class="btn red" style="flex:2" onclick="sendCommand('delay', document.getElementById('dInput').value)">DELAY ALL</button>
                </div>
                <button class="btn green" onclick="sendCommand('boarding')">SET ALL TO BOARDING</button>
                <button class="btn red" onclick="sendCommand('msg_board', '')">CLOSE ALERT BOX</button>
            </div>
        </div>

        <div class="section-title">MEDIA & HACK INJECTION</div>
        <div class="grid">
            <div class="card">
                <h2>SOUNDCLOUD CASTER</h2>
                <input type="text" id="scInput" placeholder="SoundCloud URL (e.g. https://soundcloud.com/...)">
                <button class="btn black" onclick="castSoundCloud()">CAST AUDIO TO SCREENS</button>
                
                <h2 style="margin-top: 15px;">BACKGROUND VISUALIZER</h2>
                <div class="flex-row">
                    <button class="btn" style="flex:1" onclick="sendCommand('sc_bg', 'topo')">TOPO WAVES</button>
                    <button class="btn" style="flex:1" onclick="sendCommand('sc_bg', 'globe')">3D GLOBE</button>
                    <button class="btn" style="flex:1" onclick="sendCommand('sc_bg', 'blur')">ALBUM BLUR</button>
                </div>
                
                <div id="sc-admin-preview" style="display: none; margin-top: 15px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; color: white; flex-direction: column;">
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                        <div class="admin-art-wrapper">
                            <img id="sc-admin-art" src="" style="width: 50px; height: 50px; border-radius: 4px; object-fit: cover; display: block;">
                        </div>
                        <div style="display: flex; flex-direction: column; overflow: hidden; flex: 1;">
                            <span style="font-size: 10px; color: #aaa; font-weight: bold; letter-spacing: 1px;">NOW CASTING</span>
                            <span id="sc-admin-title" style="font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px;">LOADING...</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%;">
                        <span id="sc-time-current" style="font-size: 10px; font-family: monospace; color: #aaa;">00:00</span>
                        <input type="range" id="sc-progress" min="0" max="1" step="0.01" value="0" style="flex: 1;" onchange="seekTrack(this.value)">
                        <span id="sc-time-total" style="font-size: 10px; font-family: monospace; color: #aaa;">00:00</span>
                    </div>
                    <div class="flex-row" style="gap: 5px;">
                        <button class="btn black" style="margin:0;" onclick="sendCommand('sc_pause')">PAUSE</button>
                        <button class="btn black" style="margin:0;" onclick="sendCommand('sc_play')">PLAY</button>
                        <button class="btn black" style="margin:0;" onclick="sendCommand('sc_skip')">SKIP >></button>
                        <button class="btn black" style="margin:0;" onclick="sendCommand('sc_shuffle')">SHUFFLE</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>VISUAL CHAOS</h2>
                <div class="flex-row">
                    <button class="btn" style="flex:1" onclick="sendCommand('mirror')">MIRROR</button>
                    <button class="btn" style="flex:1" onclick="sendCommand('invert')">INVERT</button>
                </div>
                <div class="flex-row">
                    <button class="btn" style="flex:1" onclick="sendCommand('shake')">SHAKE</button>
                    <button class="btn" style="flex:1" onclick="sendCommand('disco')">DISCO</button>
                </div>
                <button class="btn black" onclick="sendCommand('scramble')">SCRAMBLE BOARD DATA</button>
                <button class="btn" onclick="sendCommand('deepfried')">DEEP FRIED MODE</button>

                <h2 style="margin-top: 15px;">JUMPSCARES & FAILS</h2>
                <div class="flex-row">
                    <button class="btn red" onclick="sendCommand('roblox')">ROBLOX JUMP</button>
                    <button class="btn red" onclick="sendCommand('meme')">MEME JUMP</button>
                </div>
                <button class="btn red" onclick="sendCommand('bluescreen')">FORCE BSOD</button>
                <button class="btn red" onclick="sendCommand('winupdate')">FAKE WIN UPDATE</button>
            </div>
            
            <div class="card">
                <h2>AI TERMINAL & DVD</h2>
                <textarea id="termInput" rows="3" placeholder="Terminal text (use \n for new lines)..."></textarea>
                <button class="btn black" onclick="sendCommand('terminal', document.getElementById('termInput').value || '> SYSTEM OVERRIDE...')">INJECT TERMINAL</button>
                <button class="btn" onclick="sendCommand('dvd')">DVD BOUNCE MODE</button>
                <button class="btn black" onclick="sendCommand('hacker')">MATRIX OVERLAY</button>

                <h2 style="margin-top: 15px;">FULL SCREEN ALERT</h2>
                <textarea id="mInput" rows="2" placeholder="Warning Text..."></textarea>
                <button class="btn red" onclick="sendCommand('msg_board', document.getElementById('mInput').value)">SEND ALERT BOX</button>
            </div>
        </div>

        <div class="section-title">SYSTEM ADMINISTRATION</div>
        <div class="grid">
            <div class="card">
                <h2>CLOUD USER MANAGEMENT</h2>
                <input type="text" id="newU" placeholder="New Username">
                <input type="password" id="newP" placeholder="New Password">
                <button class="btn black" onclick="addCloudUser()">ADD USER TO CLOUD VAULT</button>
            </div>
            <div class="card">
                <h2>WEATHER OVERRIDE</h2>
                <input type="text" id="wInput" placeholder="Temp/Condition...">
                <button class="btn black" onclick="sendCommand('weather', document.getElementById('wInput').value)">SET GLOBAL WEATHER</button>
            </div>
        </div>

        <div style="text-align: center; padding: 40px 0 20px 0; font-size: 10px; color: #999; letter-spacing: 2px; font-weight: bold;">
            &copy; COPYRIGHT OLIVER KOCH AND OLIVER KOCH STUDIOS
        </div>
    </div>

    <script>
        const canvas = document.getElementById('globe-canvas');
        const ctx = canvas.getContext('2d');
        let w, h, points = [], angle = 0;
        function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        const phi = Math.PI * (3 - Math.sqrt(5));
        for (let i = 0; i < 800; i++) {
            const y = 1 - (i / 799) * 2;
            const radius = Math.sqrt(1 - y * y);
            const theta = phi * i;
            points.push({ x: Math.cos(theta)*radius, y, z: Math.sin(theta)*radius, char: "X?#@&$"[i%6] });
        }
        function draw() {
            ctx.clearRect(0,0,w,h);
            ctx.font = "14px monospace"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            angle += 0.003;
            const cosA = Math.cos(angle), sinA = Math.sin(angle);
            const projected = points.map(p => {
                const rx = p.x * cosA - p.z * sinA, rz = p.z * cosA + p.x * sinA;
                const scale = (Math.min(w,h)*0.8) / (rz + 3);
                return { x: w/2 + rx*scale, y: h/2 + p.y*scale, z: rz, char: p.char };
            }).sort((a,b) => b.z - a.z);
            
            const isDark = document.body.classList.contains('dark-mode');
            projected.forEach(p => {
                const alpha = (p.z + 1) / 2;
                const opacity = 0.2 + (alpha * 0.8);
                ctx.fillStyle = isDark ? `rgba(255,255,255,${opacity})` : `rgba(0,0,0,${opacity})`;
                ctx.fillText(p.char, p.x, p.y);
            });
            requestAnimationFrame(draw);
        }
        draw();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, set, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://trackless-controller-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let isAuthorized = false;
        let isSeeking = false;
        let trainList = [];
        let usersDB = {};

        // --- STAGE 1: FETCH CLOUD USERS ---
        get(ref(db, 'remote/users')).then((snapshot) => {
            if (snapshot.exists()) {
                usersDB = snapshot.val();
            } else {
                // Failsafe: Create default Admin if vault is empty
                usersDB = { "Admin": "1234" };
                set(ref(db, 'remote/users'), usersDB);
            }
        });

        // THE FIX: Forces text comparison and removes spaces
        window.checkCloudCredentials = () => {
            const u = document.getElementById('logUser').value.trim();
            const p = document.getElementById('logPass').value.trim();
            
            if (usersDB[u] && String(usersDB[u]) === String(p)) {
                // Match! Move to Code Stage
                document.getElementById('auth-stage-1').style.display = 'none';
                document.getElementById('auth-stage-2').style.display = 'block';
            } else {
                console.log("Database sees:", usersDB);
                alert("ACCESS DENIED: INCORRECT USERNAME OR PASSWORD.");
            }
        };

        // --- STAGE 2: VERIFY MASTER CODE ---
        window.verifySecretCode = async () => {
            const input = document.getElementById('accessCode').value.trim();
            try {
                const snap = await get(ref(db, 'remote/config/access_code'));
                if (snap.exists() && String(input) === String(snap.val())) {
                    unlockUI();
                } else {
                    alert("ACCESS DENIED: INCORRECT SECURE VAULT CODE.");
                    location.reload(); // Kick them out
                }
            } catch (err) {
                console.error(err);
                alert("DATABASE ERROR: Code check failed.");
            }
        };

        // --- UNLOCK UI & START DATA STREAMS ---
        function unlockUI() {
            isAuthorized = true;
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block'; 
                startDataStreams(); 
            }, 500);
        }

        // --- CLOUD USER MANAGEMENT ---
        window.addCloudUser = () => {
            if (!isAuthorized) return;
            const u = document.getElementById('newU').value.trim();
            const p = document.getElementById('newP').value.trim();
            if (u && p) {
                update(ref(db, 'remote/users'), { [u]: p });
                alert("NEW USER ADDED TO SECURE VAULT!");
                document.getElementById('newU').value = "";
                document.getElementById('newP').value = "";
                // Update local copy
                usersDB[u] = p;
            } else {
                alert("Please enter a username and password.");
            }
        };

        // --- COMMAND ENGINE ---
        window.sendCommand = (event, val = "", manualTarget = null) => {
            if (!isAuthorized) return;
            
            const dangerous = ['reset', 'blackout', 'kick', 'bluescreen', 'soft_reset'];
            if (dangerous.includes(event) && !confirm(`WARNING: TRIGGER [${event.toUpperCase()}]?`)) return;

            const target = manualTarget || document.getElementById('target-select').value;
            push(ref(db, 'remote/commands'), { event, value: val, target, ts: Date.now() });
        };

        // --- SOUNDCLOUD CASTER ---
        window.seekTrack = (value) => {
            window.sendCommand('sc_seek', value);
            setTimeout(() => { isSeeking = false; }, 1000); 
        };
        document.getElementById('sc-progress').addEventListener('mousedown', () => { isSeeking = true; });
        document.getElementById('sc-progress').addEventListener('touchstart', () => { isSeeking = true; });

        window.castSoundCloud = () => {
            const url = document.getElementById('scInput').value;
            const preview = document.getElementById('sc-admin-preview');
            if (!url) return;

            preview.style.display = 'flex';
            document.getElementById('sc-admin-title').innerText = "FETCHING TRACK...";
            document.getElementById('sc-admin-art').src = "";
            
            fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(url)}`)
                .then(res => res.json())
                .then(data => {
                    let artUrl = data.thumbnail_url ? data.thumbnail_url.replace('large', 't500x500') : '';
                    document.getElementById('sc-admin-art').src = artUrl;
                    document.getElementById('sc-admin-title').innerText = data.title.toUpperCase();

                    const payload = { url, title: data.title, art: artUrl, autoPlay: true, playRelated: true };
                    window.sendCommand('soundcloud', JSON.stringify(payload));
                }).catch(() => {
                    document.getElementById('sc-admin-title').innerText = "UNKNOWN TRACK";
                });
        };

        window.clearMedia = () => {
            window.sendCommand('clear_media');
            document.getElementById('sc-admin-preview').style.display = 'none';
            document.getElementById('scInput').value = "";
        };

        // --- DATA STREAMS (TRAINS, MEDIA, NETWORK) ---
        function startDataStreams() {
            
            // 1. Fetch Trains
            get(ref(db, 'remote/trains')).then(s => {
                trainList = s.exists() ? s.val() : [
                    { time: "09:30", type: "IC", dest: "KÃ˜BENHAVN H", track: "4", status: "TIL TIDEN", color: "white", blink: false }
                ];
                renderTrainEditor();
            });

            // 2. Media Tracking
            function formatTime(ms) {
                let s = Math.floor(ms / 1000); let m = Math.floor(s / 60); s = s % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            onValue(ref(db, 'remote/media_state'), (snapshot) => {
                if (snapshot.exists()) {
                    const state = snapshot.val();
                    if (state.totalTime > 0) {
                        document.getElementById('sc-time-total').innerText = formatTime(state.totalTime);
                        document.getElementById('sc-time-current').innerText = formatTime(state.currentTime);
                        if (!isSeeking) { document.getElementById('sc-progress').value = (state.currentTime / state.totalTime); }
                    }
                }
            });

            // 3. Network Monitor
            let lastKnownScreens = {};
            let screenStartTimes = {};
            onValue(ref(db, 'remote/screens'), (s) => { lastKnownScreens = s.val() || {}; });

            setInterval(() => {
                const tbody = document.getElementById('network-body');
                const select = document.getElementById('target-select');
                const now = Date.now();
                const currentTarget = select.value;
                
                select.innerHTML = '<option value="ALL">BROADCAST TO ALL SCREENS</option>';
                tbody.innerHTML = '';

                let hasActive = false;

                Object.keys(lastKnownScreens).forEach(id => {
                    const ping = now - lastKnownScreens[id].heartbeat;
                    const online = ping < 10000;
                    const unstable = ping >= 3000 && ping < 10000;

                    if (online) {
                        hasActive = true;
                        if (!screenStartTimes[id]) screenStartTimes[id] = now;
                        select.innerHTML += `<option value="${id}">${id}</option>`;
                    } else {
                        delete screenStartTimes[id];
                    }

                    let uptimeStr = "00:00:00";
                    if (online && screenStartTimes[id]) {
                        const diff = now - screenStartTimes[id];
                        const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                        const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                        const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                        uptimeStr = `${h}:${m}:${s}`;
                    }

                    let dot = '#E3000F'; let text = 'LOST CONNECTION'; 
                    if (online && !unstable) { dot = '#2ecc71'; text = 'STABLE CONNECTION'; }
                    else if (unstable) { dot = '#FFD700'; text = 'UNSTABLE CONNECTION'; }

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${id}</strong></td>
                            <td><span class="status-dot" style="background:${dot}"></span><span style="color:${dot}; font-weight:bold;">${text}</span></td>
                            <td>${online ? ping + ' ms' : 'N/A'}</td>
                            <td style="font-family:monospace; font-weight:bold;">${uptimeStr}</td>
                            <td><button class="btn black" style="margin:0; width:auto; padding:5px 15px;" onclick="sendCommand('kick', '', '${id}')">KICK</button></td>
                        </tr>
                    `;
                });

                if (!hasActive) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">NO SCREENS DETECTED</td></tr>';
                if (Array.from(select.options).some(o => o.value === currentTarget)) select.value = currentTarget;

            }, 1000);
        }

        // --- TRAIN MGMT FUNCTIONS ---
        window.renderTrainEditor = () => {
            const el = document.getElementById('train-editor');
            el.innerHTML = trainList.map((t, i) => `
                <div class="flex-row" style="margin-bottom:8px;">
                    <input type="text" id="t-time-${i}" value="${t.time}" style="flex:0.6" placeholder="00:00">
                    <input type="text" id="t-type-${i}" value="${t.type}" style="flex:0.8" placeholder="Type">
                    <input type="text" id="t-dest-${i}" value="${t.dest}" style="flex:2" placeholder="Destination">
                    <input type="text" id="t-track-${i}" value="${t.track}" style="flex:0.5" placeholder="Sp" style="text-align:center;">
                    <input type="text" id="t-stat-${i}" value="${t.status}" style="flex:1.5" placeholder="Status">
                    <select id="t-col-${i}" style="flex:1">
                        <option value="white" ${t.color==='white'?'selected':''}>WHITE</option>
                        <option value="red" ${t.color==='red'?'selected':''}>RED</option>
                        <option value="yellow" ${t.color==='yellow'?'selected':''}>YELLOW</option>
                        <option value="green" ${t.color==='green'?'selected':''}>GREEN</option>
                    </select>
                    <label style="flex:0.5; font-size:10px; cursor:pointer; white-space:nowrap;"><input type="checkbox" id="t-blk-${i}" ${t.blink?'checked':''}> BLINK</label>
                    <button class="btn red" style="width:auto; margin:0; flex:0.3;" onclick="removeTrain(${i})">X</button>
                </div>
            `).join('');
        };

        window.addNewTrain = () => {
            trainList.push({ time: "00:00", type: "RE", dest: "NEW DESTINATION", track: "1", status: "TIL TIDEN", color: "white", blink: false });
            renderTrainEditor();
        };

        window.removeTrain = (i) => {
            trainList.splice(i, 1);
            renderTrainEditor();
        };

        window.syncTrainBoard = () => {
            if (!isAuthorized) return;
            trainList.forEach((t, i) => {
                t.time = document.getElementById(`t-time-${i}`).value;
                t.type = document.getElementById(`t-type-${i}`).value;
                t.dest = document.getElementById(`t-dest-${i}`).value;
                t.track = document.getElementById(`t-track-${i}`).value;
                t.status = document.getElementById(`t-stat-${i}`).value;
                t.color = document.getElementById(`t-col-${i}`).value;
                t.blink = document.getElementById(`t-blk-${i}`).checked;
            });
            set(ref(db, 'remote/trains'), trainList);
            alert("BOARD SYNCHRONIZED TO ALL SCREENS.");
        };

        window.cancelAllTrains = () => {
            trainList.forEach((t) => { t.status = "AFLYST"; t.color = "red"; t.blink = true; });
            renderTrainEditor();
            window.syncTrainBoard();
        };
    </script>
</body>
</html>