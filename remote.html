<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MASTER ADMIN - SRE Hub</title>
    <style>
        body { background: #fdfdfd; color: #000; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-transform: uppercase; overflow-x: hidden; position: relative; }
        
        /* --- GLOBE BACKGROUND --- */
        #globe-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0; pointer-events: none; opacity: 0.15;
        }

        /* --- CLEAN WHITE INTRO --- */
        #intro-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ffffff; z-index: 9999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 1s ease-in-out; color: #000;
        }
        #intro-screen img { max-width: 200px; margin-bottom: 30px; }
        #intro-screen h1 { font-size: 20px; letter-spacing: 5px; margin: 0; font-weight: 900; }
        #intro-loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #000;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px 0;
        }
        #load-status { font-family: monospace; font-size: 12px; color: #666; text-transform: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 999999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { border: 2px solid #000; padding: 40px; width: 320px; text-align: center; background: #fff; position: relative; z-index: 2; }
        .login-box h1 { font-size: 18px; margin-bottom: 25px; letter-spacing: 3px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; outline: none; font-size: 14px; text-transform: none; }
        .login-btn { width: 100%; padding: 12px; background: #000; color: #fff; border: none; font-weight: bold; cursor: pointer; }

        /* --- HEADER & LOGO --- */
        .master-header { text-align: center; padding: 40px 0; border-bottom: 1px solid #eee; background: rgba(255,255,255,0.9); position: relative; z-index: 1; }
        .master-header img { height: 120px; margin-bottom: 10px; }
        .master-header h1 { font-size: 14px; letter-spacing: 10px; margin: 0; color: #000; }

        /* --- MAIN UI --- */
        .container { max-width: 1300px; margin: 0 auto; padding: 25px; position: relative; z-index: 1; }
        .target-box { background: #fff; border: 1px solid #000; padding: 20px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        select { padding: 10px; font-weight: bold; border: 1px solid #000; cursor: pointer; background: white; }

        .section-title { font-size: 12px; letter-spacing: 4px; font-weight: 900; margin: 40px 0 20px 0; border-left: 5px solid #000; padding-left: 15px; background: rgba(255,255,255,0.8); display: inline-block; padding-right: 15px;}

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: rgba(255,255,255,0.95); border: 1px solid #eee; padding: 25px; transition: 0.2s; position: relative; overflow: hidden; backdrop-filter: blur(5px); }
        .card:hover { border-color: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        h2 { font-size: 10px; color: #999; margin: 0 0 15px 0; letter-spacing: 2px; }

        /* --- BUTTONS --- */
        .btn { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #000; background: #fff; color: #000; font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .btn:hover { background: #000; color: #fff; }
        .btn.black { background: #000; color: #fff; }
        .btn.red { border-color: #E3000F; color: #E3000F; }
        .btn.red:hover { background: #E3000F; color: #fff; }
        .btn.green { border-color: #2ecc71; color: #2ecc71; }
        .btn.green:hover { background: #2ecc71; color: #fff; }

        input, textarea { width: 100%; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; box-sizing: border-box; font-family: sans-serif; font-size: 12px; outline: none; background: rgba(255,255,255,0.9); }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        
        /* NETWORK TABLE */
        table.net-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 12px; margin-top: 15px; }
        table.net-table th { border-bottom: 2px solid #000; padding-bottom: 10px; color: #999; }
        table.net-table td { padding: 12px 0; border-bottom: 1px solid #eee; }

        /* DROPDOWN DETAILS STYLING */
        details.dropdown-card summary { list-style: none; outline: none; cursor: pointer; font-size: 12px; font-weight: 900; letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid transparent; padding-bottom: 5px;}
        details.dropdown-card summary::-webkit-details-marker { display: none; }
        details.dropdown-card[open] summary { border-bottom: 2px solid #1f6feb; margin-bottom: 15px; }
        details.dropdown-card summary:hover { color: #1f6feb; }
        
        /* STATUS DOT */
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

        /* --- DARK MODE --- */
        body.dark-mode { background: #111; color: #eee; }
        body.dark-mode #intro-screen, body.dark-mode #login-screen { background: #111; color: #eee; }
        body.dark-mode .login-box { background: #222; border-color: #555; }
        body.dark-mode .login-box input { background: #333; color: #eee; border: none; }
        body.dark-mode .login-btn { background: #eee; color: #111; }
        body.dark-mode .master-header { background: rgba(17,17,17,0.9); border-bottom: 1px solid #333; }
        body.dark-mode .master-header h1 { color: #eee; }
        body.dark-mode .target-box, body.dark-mode .card { background: rgba(30,30,30,0.95); border-color: #444; color:#eee;}
        body.dark-mode .section-title { background: rgba(17,17,17,0.8); border-left-color: #eee; color:#eee;}
        body.dark-mode select, body.dark-mode input, body.dark-mode textarea { background: #333; color: #eee; border-color: #555; }
        body.dark-mode .btn { background: #333; color: #eee; border-color: #555; }
        body.dark-mode .btn:hover { background: #eee; color: #111; }
        body.dark-mode .btn.black { background: #eee; color: #111; }
        body.dark-mode table.net-table th { border-bottom-color: #555; color: #bbb; }
        body.dark-mode table.net-table td { border-bottom-color: #333; }
        body.dark-mode .login-box h1 { color: #eee; }
    </style>
</head>
<body>

    <canvas id="globe-canvas"></canvas>

    <div id="intro-screen">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>ADMIN INITIALIZING</h1>
        <div id="intro-loader"></div>
        <div id="load-status">Connecting to servers...</div>
        <div style="margin-top: 20px; font-size: 10px; letter-spacing: 2px;">OLIVER TECH HUB v11.0</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h1>SYSTEM ACCESS</h1>
            <input type="text" id="logUser" placeholder="USERNAME">
            <input type="password" id="logPass" placeholder="PASSWORD">
            <button class="login-btn" onclick="checkLogin()">AUTHENTICATE</button>
        </div>
    </div>

    <div class="master-header">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>OLIVER TECH</h1>
    </div>

    <div class="container">
        <div class="target-box">
            <span>COMMAND TARGET:</span>
            <select id="target-screen"><option value="ALL">ALL ACTIVE SCREENS</option></select>
            <button class="btn black" style="width:auto; margin:0;" onclick="sendCommand('toggle_id')">TOGGLE ID TAGS</button>
            <button class="btn" style="width:auto; margin:0; margin-left: 10px;" onclick="document.body.classList.toggle('dark-mode')">DARK MODE</button>
        </div>

        <div class="section-title">NETWORK DASHBOARD (LIVE)</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <details class="card dropdown-card" style="border: 2px solid #1f6feb;" open>
                <summary>
                    <span>▼ CONNECTION MENU (CLICK TO EXPAND)</span>
                    <span style="color:#1f6feb;">LIVE</span>
                </summary>
                <table class="net-table">
                    <thead>
                        <tr>
                            <th>SCREEN ID</th>
                            <th>STATUS</th>
                            <th>PING</th>
                            <th>WIFI SPEED</th>
                            <th>UPTIME</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="network-tbody">
                        </tbody>
                </table>
            </details>
        </div>

        <div class="section-title">NUCLEAR CONTROL CENTER</div>
        <div class="grid">
            <div class="card" style="border: 2px solid #2ecc71;">
                <h2>RESETS & CLEARS</h2>
                <button class="btn green" onclick="clearMedia()">STOP ALL OVERLAYS & AUDIO</button>
                <button class="btn green" onclick="sendCommand('clear_fx')">REMOVE VISUAL FX</button>
                <button class="btn green" onclick="clearTicker()">REVERT TO DR NEWS</button>
                <button class="btn green" onclick="sendCommand('reset_trains')">NORMALIZE TRAINS</button>
            </div>
            <div class="card" style="border: 2px solid #000;">
                <h2>ID TAG CONTROL</h2>
                <button class="btn black" onclick="sendCommand('show_id')">SHOW ALL ID TAGS</button>
                <button class="btn black" onclick="sendCommand('hide_id')">HIDE ALL ID TAGS</button>
            </div>
            <div class="card" style="border: 2px solid #E3000F;">
                <h2>EMERGENCY STOP</h2>
                <button class="btn red" onclick="sendCommand('blackout')">FORCE BLACKOUT</button>
                <button class="btn red" onclick="sendCommand('reset')">HARD SYSTEM REBOOT</button>
                <button class="btn black" onclick="sendCommand('msg_board', '')">CLOSE ALERT BOX</button>
            </div>
        </div>

        <div class="section-title">TRAIN BOARD MANAGEMENT</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card">
                <h2>ADD, DELETE, AND EDIT LIVE TRAINS</h2>
                <div id="train-manager-list" style="margin-bottom: 20px;">
                    </div>
                <div class="flex-row">
                    <button class="btn black" onclick="addTrain()">+ ADD NEW TRAIN</button>
                    <button class="btn green" onclick="saveAndPushTrains()">SAVE & PUSH TO SCREENS</button>
                </div>
            </div>
        </div>

        <div class="section-title">GLOBAL SRE CONTROLS</div>
        <div class="grid">
            <div class="card">
                <h2>TICKER & BROADCAST</h2>
                <input type="text" id="tInput" placeholder="Override news feed...">
                <button class="btn black" onclick="sendCommand('ticker', document.getElementById('tInput').value)">SEND HEADLINE</button>
                <button class="btn red" style="margin-top:10px" onclick="sendCommand('status', 'PREMIERE NU')">SET LIVE STATUS</button>
                <button class="btn" onclick="sendCommand('status', 'KLAR')">RESET STATUS</button>
            </div>
            
            <div class="card">
                <h2>GLOBAL TRAIN STATUS</h2>
                <div class="flex-row">
                    <input type="number" id="dInput" placeholder="Min" style="flex:1">
                    <button class="btn red" style="flex:2" onclick="sendCommand('delay', document.getElementById('dInput').value)">DELAY ALL</button>
                </div>
                <button class="btn green" onclick="sendCommand('boarding')">SET ALL TO BOARDING</button>
                <button class="btn red" onclick="cancelAllTrains()">CANCEL ALL TRAINS</button>
            </div>

            <div class="card">
                <h2>MEDIA OVERLAYS</h2>
                <textarea id="mInput" rows="2" placeholder="Overlay text..."></textarea>
                <button class="btn red" onclick="sendCommand('msg_board', document.getElementById('mInput').value)">SEND FULL SCREEN ALERT</button>
                
                <h2 style="margin-top: 15px;">SOUNDCLOUD CASTER</h2>
                <div class="flex-row">
                    <input type="text" id="scInput" placeholder="SoundCloud URL (e.g. https://soundcloud.com/...)" style="flex: 2; margin-bottom: 0;">
                    <button class="btn black" style="flex: 1; margin-bottom: 0;" onclick="castSoundCloud()">CAST AUDIO</button>
                </div>
                
                <div id="sc-admin-preview" style="display: none; margin-top: 15px; background: rgba(0,0,0,0.85); padding: 10px; border-radius: 8px; color: white; align-items: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                    <img id="sc-admin-art" src="" style="width: 50px; height: 50px; border-radius: 5px; object-fit: cover; border: 2px solid #E3000F;">
                    <div style="display: flex; flex-direction: column; overflow: hidden;">
                        <span style="font-size: 10px; color: #E3000F; font-weight: bold; letter-spacing: 1px;">NOW CASTING TO SCREENS</span>
                        <span id="sc-admin-title" style="font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px;">LOADING...</span>
                    </div>
                </div>

            </div>
        </div>

        <div class="section-title">THE MESS AROUND HACKS</div>
        <div class="grid">
            <div class="card">
                <h2>AI TERMINAL & DVD</h2>
                <textarea id="termInput" rows="3" placeholder="AI text (use \n for lines)..."></textarea>
                <button class="btn black" onclick="sendTerminal()">INJECT TERMINAL</button>
                <button class="btn" onclick="sendCommand('dvd')">DVD BOUNCE MODE</button>
                <button class="btn black" onclick="sendCommand('hacker')">MATRIX OVERLAY</button>
            </div>

            <div class="card">
                <h2>VISUAL CHAOS</h2>
                <div class="flex-row">
                    <button class="btn" onclick="sendCommand('mirror')">MIRROR</button>
                    <button class="btn" onclick="sendCommand('invert')">INVERT</button>
                </div>
                <div class="flex-row">
                    <button class="btn" onclick="sendCommand('shake')">SHAKE</button>
                    <button class="btn" onclick="sendCommand('disco')">DISCO</button>
                </div>
                <button class="btn black" onclick="sendCommand('scramble')">SCRAMBLE BOARD</button>
                <button class="btn" onclick="sendCommand('deepfried')">DEEP FRIED MODE</button>
            </div>

            <div class="card">
                <h2>JUMPSCARES & FAILS</h2>
                <div class="flex-row">
                    <button class="btn red" onclick="sendCommand('roblox')">ROBLOX JUMP</button>
                    <button class="btn red" onclick="sendCommand('meme')">MEME JUMP</button>
                </div>
                <button class="btn red" onclick="sendCommand('bluescreen')">BSOD</button>
                <button class="btn red" onclick="sendCommand('winupdate')">FORCE WIN UPDATE</button>
            </div>
        </div>

        <div class="section-title">SYSTEM ADMINISTRATION</div>
        <div class="grid">
            <div class="card">
                <h2>USER MANAGEMENT</h2>
                <input type="text" id="newU" placeholder="Username">
                <input type="password" id="newP" placeholder="Password">
                <button class="btn black" onclick="addUser()">ADD ADMIN USER</button>
            </div>
            <div class="card">
                <h2>WEATHER OVERRIDE</h2>
                <input type="text" id="wInput" placeholder="Temp/Condition...">
                <button class="btn black" onclick="sendCommand('weather', document.getElementById('wInput').value)">SET GLOBAL WEATHER</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('globe-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeGlobe() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeGlobe);
        resizeGlobe();

        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*".split('');
        const points = [];
        const numPoints = 800; 

        const phi = Math.PI * (3 - Math.sqrt(5));
        for (let i = 0; i < numPoints; i++) {
            const y = 1 - (i / (numPoints - 1)) * 2;
            const radiusAtY = Math.sqrt(1 - y * y);
            const theta = phi * i;
            
            const x = Math.cos(theta) * radiusAtY;
            const z = Math.sin(theta) * radiusAtY;
            
            points.push({ x, y, z, char: chars[Math.floor(Math.random() * chars.length)] });
        }

        let angle = 0;
        function drawGlobe() {
            ctx.clearRect(0, 0, width, height);
            ctx.font = "14px monospace";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            angle += 0.003; 
            
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);
            const projected = [];
            
            for (let i = 0; i < numPoints; i++) {
                const p = points[i];
                const rotX = p.x * cosA - p.z * sinA;
                const rotZ = p.z * cosA + p.x * sinA;
                const rotY = p.y;
                
                const distance = 3;
                const z = rotZ + distance;
                const scale = (Math.min(width, height) * 0.8) / z;
                
                const screenX = width / 2 + rotX * scale;
                const screenY = height / 2 + rotY * scale;
                
                projected.push({screenX, screenY, z: rotZ, char: p.char});
            }
            
            projected.sort((a, b) => b.z - a.z);
            
            // --- GLOBE COLOR LOGIC ---
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            for (let i = 0; i < numPoints; i++) {
                const p = projected[i];
                const alpha = (p.z + 1) / 2; 
                const opacity = 0.2 + (alpha * 0.8);
                
                if (isDarkMode) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                } else {
                    ctx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
                }
                
                ctx.fillText(p.char, p.screenX, p.screenY);
            }
            requestAnimationFrame(drawGlobe);
        }
        drawGlobe();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://trackless-controller-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Auth State ---
        let isLoggedIn = false;
        let usersDB = {};

        // Intro Logic
        let introIdx = 0;
        const statusEl = document.getElementById('load-status');
        const introInterval = setInterval(() => { if(introIdx < 4) introIdx++; statusEl.innerText = "Syncing Hub..."; }, 800);
        setTimeout(() => { document.getElementById('intro-screen').style.opacity = '0'; setTimeout(() => document.getElementById('intro-screen').style.display = 'none', 1000); }, 3500);

        // Fetch Users from Firebase
        get(ref(db, 'remote/users')).then((snapshot) => {
            if (snapshot.exists()) {
                usersDB = snapshot.val();
            } else {
                usersDB = { "Oliver": "3112" };
                set(ref(db, 'remote/users'), usersDB);
            }
            
            onValue(ref(db, 'remote/users'), (liveSnap) => {
                if (liveSnap.exists()) {
                    usersDB = liveSnap.val();
                }
            });
        });

        window.checkLogin = () => { 
            const u = document.getElementById('logUser').value;
            const p = document.getElementById('logPass').value;
            
            if (usersDB[u] && usersDB[u] === p) {
                isLoggedIn = true;
                document.getElementById('login-screen').style.display = 'none'; 
            } else { 
                alert("ACCESS DENIED: Incorrect Username or Password"); 
            }
        };

        window.addUser = () => { 
            if (!isLoggedIn) {
                alert("You must be logged in to add users.");
                return;
            }
            const u = document.getElementById('newU').value;
            const p = document.getElementById('newP').value;
            if (u && p) { 
                update(ref(db, 'remote/users'), { [u]: p }); 
                alert("USER ADDED TO DATABASE!"); 
                document.getElementById('newU').value = ""; document.getElementById('newP').value = "";
            } 
        };

        // Command Sender 
        window.sendCommand = (event, val = "", overrideTarget = null) => {
            if (!isLoggedIn) {
                alert("Session expired. Please log in.");
                return;
            }

            const dangerousEvents = ['reset', 'blackout', 'kick', 'bluescreen'];
            if (dangerousEvents.includes(event)) {
                if (!confirm(`WARNING: You are about to trigger [${event.toUpperCase()}]. Proceed?`)) return;
            }

            const target = overrideTarget || document.getElementById('target-screen').value;
            update(ref(db, 'remote/commands'), { 
                event: event, 
                value: val, 
                target: target, 
                ts: Date.now() 
            });
        };

        // --- NEW: SOUNDCLOUD CASTER FUNCTION ---
        window.castSoundCloud = () => {
            const url = document.getElementById('scInput').value;
            
            // 1. Send the command to the screens
            window.sendCommand('soundcloud', url); 
            
            // 2. Update Admin Panel Preview
            const preview = document.getElementById('sc-admin-preview');
            if (!url || url === "") {
                preview.style.display = 'none';
                return;
            }
            
            preview.style.display = 'flex';
            document.getElementById('sc-admin-title').innerText = "FETCHING TRACK...";
            document.getElementById('sc-admin-art').src = "";
            
            // Ask SoundCloud for the track details just like the Display Hub does
            fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(url)}`)
            .then(res => res.json())
            .then(data => {
                let artUrl = data.thumbnail_url ? data.thumbnail_url.replace('large', 't500x500') : '';
                document.getElementById('sc-admin-art').src = artUrl;
                document.getElementById('sc-admin-title').innerText = data.title.toUpperCase();
            }).catch(e => {
                document.getElementById('sc-admin-title').innerText = "UNKNOWN TRACK";
            });
        };

        // --- NEW: CLEAR MEDIA UPDATED ---
        window.clearMedia = () => {
            window.sendCommand('clear_media');
            // Hide the admin preview as well
            document.getElementById('sc-admin-preview').style.display = 'none';
            document.getElementById('scInput').value = "";
        };

        let trainData = [];
        get(ref(db, 'remote/trains')).then((snapshot) => {
            if (snapshot.exists()) {
                trainData = snapshot.val();
            } else {
                trainData = [
                    { time: "09:30", type: "IC", dest: "KØBENHAVN H", track: "4", status: "TIL TIDEN", color: "white", blink: false },
                    { time: "10:00", type: "RE", dest: "LYDFIL VIA SLIPKØBING", track: "2", status: "TIL TIDEN", color: "white", blink: false },
                    { time: "10:45", type: "RE", dest: "TUNG BYRDE VIA MODYBY", track: "3", status: "TIL TIDEN", color: "white", blink: false },
                    { time: "11:00", type: "SPIL", dest: "SPORLØS PREMIERE", track: "1", status: "KLAR", color: "red", blink: true },
                    { time: "11:30", type: "RE", dest: "HJEMBY", track: "1", status: "TIL TIDEN", color: "white", blink: false },
                    { time: "12:15", type: "ICL", dest: "VIRKELIGHEDEN", track: "4", status: "TIL TIDEN", color: "white", blink: false }
                ];
            }
            renderTrainManager();
        });

        window.renderTrainManager = () => {
            const container = document.getElementById('train-manager-list');
            container.innerHTML = '';
            trainData.forEach((train, index) => {
                const row = document.createElement('div');
                row.className = "flex-row";
                row.style.marginBottom = "10px";
                row.innerHTML = `
                    <input type="text" id="t-time-${index}" value="${train.time}" placeholder="Time" style="flex:0.8; margin:0;">
                    <input type="text" id="t-type-${index}" value="${train.type}" placeholder="Type (IC, RE...)" style="flex:1; margin:0;">
                    <input type="text" id="t-dest-${index}" value="${train.dest}" placeholder="Destination" style="flex:2; margin:0;">
                    <input type="text" id="t-track-${index}" value="${train.track}" placeholder="Track" style="flex:0.5; margin:0; text-align:center;">
                    <input type="text" id="t-status-${index}" value="${train.status}" placeholder="Status" style="flex:1.5; margin:0;">
                    <select id="t-color-${index}" style="flex:1; margin:0; padding:10px;">
                        <option value="white" ${train.color==='white'?'selected':''}>WHITE</option>
                        <option value="red" ${train.color==='red'?'selected':''}>RED</option>
                        <option value="yellow" ${train.color==='yellow'?'selected':''}>YELLOW</option>
                        <option value="green" ${train.color==='green'?'selected':''}>GREEN</option>
                    </select>
                    <label style="font-size: 10px; cursor:pointer; flex:0.5; margin:0; white-space:nowrap;">
                        <input type="checkbox" id="t-blink-${index}" ${train.blink?'checked':''}> BLINK
                    </label>
                    <button class="btn red" style="flex:0.3; margin:0;" onclick="removeTrain(${index})">X</button>
                `;
                container.appendChild(row);
            });
        };

        window.addTrain = () => {
            trainData.push({ time: "00:00", type: "RE", dest: "NEW DESTINATION", track: "1", status: "TIL TIDEN", color: "white", blink: false });
            renderTrainManager();
        };

        window.removeTrain = (index) => {
            trainData.splice(index, 1);
            renderTrainManager();
        };

        window.saveAndPushTrains = () => {
            if (!isLoggedIn) {
                alert("Session expired. Please log in.");
                return;
            }

            trainData.forEach((train, index) => {
                train.time = document.getElementById(`t-time-${index}`).value;
                train.type = document.getElementById(`t-type-${index}`).value;
                train.dest = document.getElementById(`t-dest-${index}`).value;
                train.track = document.getElementById(`t-track-${index}`).value;
                train.status = document.getElementById(`t-status-${index}`).value;
                train.color = document.getElementById(`t-color-${index}`).value;
                train.blink = document.getElementById(`t-blink-${index}`).checked;
            });
            set(ref(db, 'remote/trains'), trainData);
            window.sendCommand('sync_trains', JSON.stringify(trainData));
            alert("BOARD UPDATED!");
        };

        window.cancelAllTrains = () => {
            trainData.forEach((t) => { t.status = "AFLYST"; t.color = "red"; t.blink = true; });
            renderTrainManager();
            saveAndPushTrains();
        };

        window.sendTerminal = () => { 
            window.sendCommand('terminal', document.getElementById('termInput').value || "> SYSTEM OVERRIDE..."); 
            document.getElementById('termInput').value = ""; 
        };

        window.clearTicker = () => { 
            document.getElementById('tInput').value = ""; 
            window.sendCommand('ticker', ""); 
        };

        // --- LIVE NETWORK MONITORING ---
        let lastKnownScreens = {};
        let screenStartTimes = {}; 
        
        onValue(ref(db, 'remote/screens'), (snapshot) => {
            lastKnownScreens = snapshot.val() || {};
        });

        function updateNetworkUI() {
            const select = document.getElementById('target-screen');
            const tbody = document.getElementById('network-tbody');
            const current = select.value;
            
            select.innerHTML = '<option value="ALL">ALL ACTIVE SCREENS</option>';
            tbody.innerHTML = '';
            
            const now = Date.now();
            let hasActiveScreens = false;

            Object.keys(lastKnownScreens).forEach(id => {
                const ping = now - lastKnownScreens[id].heartbeat;
                const isOnline = ping < 10000;
                const isUnstable = ping >= 3000 && ping < 10000;
                
                if (isOnline) {
                    if (!screenStartTimes[id]) screenStartTimes[id] = now;
                } else {
                    delete screenStartTimes[id]; 
                }

                let uptimeStr = "00:00:00";
                if (isOnline && screenStartTimes[id]) {
                    const diffMs = now - screenStartTimes[id];
                    const h = Math.floor(diffMs / 3600000).toString().padStart(2, '0');
                    const m = Math.floor((diffMs % 3600000) / 60000).toString().padStart(2, '0');
                    const s = Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0');
                    uptimeStr = `${h}:${m}:${s}`;
                }

                if (isOnline) {
                    hasActiveScreens = true;
                    const opt = document.createElement('option');
                    opt.value = id; opt.innerText = id; select.appendChild(opt);
                }

                let dotColor = '#E3000F'; 
                let statusText = 'LOST CONNECTION';
                let speedStr = '0.0 Mbps';

                if (isOnline && !isUnstable) {
                    dotColor = '#2ecc71'; 
                    statusText = 'STABLE CONNECTION';
                    speedStr = (Math.random() * 50 + 150).toFixed(1) + ' Mbps'; 
                } else if (isUnstable) {
                    dotColor = '#FFD700'; 
                    statusText = 'UNSTABLE CONNECTION';
                    speedStr = (Math.random() * 10 + 5).toFixed(1) + ' Mbps'; 
                }

                const statusHtml = `<span class="status-dot" style="background-color: ${dotColor};"></span><span style="color: ${dotColor}; font-weight: 900;">${statusText}</span>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${id}</strong></td>
                    <td>${statusHtml}</td>
                    <td>${isOnline ? ping + ' ms' : 'N/A'}</td>
                    <td>${speedStr}</td>
                    <td style="font-family: monospace; font-weight: bold;">${uptimeStr}</td>
                    <td>
                        <button class="btn black" style="margin:0; width:auto; padding: 5px 15px;" onclick="sendCommand('kick', '', '${id}')">KICK</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            if (!hasActiveScreens) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color:#999;">NO SCREENS DETECTED</td></tr>';
            }

            if (Array.from(select.options).some(o => o.value === current)) { select.value = current; }
        }

        setInterval(updateNetworkUI, 1000);

    </script>
</body>
</html>