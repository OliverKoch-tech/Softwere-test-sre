<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MASTER ADMIN - OLIVER TECH</title>
    <style>
        body { background: #fdfdfd; color: #000; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-transform: uppercase; overflow-x: hidden; position: relative; }
        
        /* --- GLOBE BACKGROUND --- */
        #globe-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0; pointer-events: none; opacity: 0.15;
        }

        /* --- CLEAN WHITE INTRO (MATCHES PROJECTOR) --- */
        #intro-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ffffff; z-index: 9999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 1s ease-in-out; color: #000;
        }
        #intro-screen img { max-width: 200px; margin-bottom: 30px; }
        #intro-screen h1 { font-size: 20px; letter-spacing: 5px; margin: 0; font-weight: 900; }
        #intro-loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #000;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px 0;
        }
        #load-status { font-family: monospace; font-size: 12px; color: #666; text-transform: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 999999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { border: 2px solid #000; padding: 40px; width: 320px; text-align: center; background: #fff; position: relative; z-index: 2; }
        .login-box h1 { font-size: 18px; margin-bottom: 25px; letter-spacing: 3px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; outline: none; font-size: 14px; text-transform: none; }
        .login-btn { width: 100%; padding: 12px; background: #000; color: #fff; border: none; font-weight: bold; cursor: pointer; }

        /* --- HEADER & LOGO --- */
        .master-header { text-align: center; padding: 40px 0; border-bottom: 1px solid #eee; background: rgba(255,255,255,0.9); position: relative; z-index: 1; }
        .master-header img { height: 120px; margin-bottom: 10px; }
        .master-header h1 { font-size: 14px; letter-spacing: 10px; margin: 0; color: #000; }

        /* --- MAIN UI --- */
        .container { max-width: 1300px; margin: 0 auto; padding: 25px; position: relative; z-index: 1; }
        .target-box { background: #fff; border: 1px solid #000; padding: 20px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        select { padding: 10px; font-weight: bold; border: 1px solid #000; cursor: pointer; background: white; }

        .section-title { font-size: 12px; letter-spacing: 4px; font-weight: 900; margin: 40px 0 20px 0; border-left: 5px solid #000; padding-left: 15px; background: rgba(255,255,255,0.8); display: inline-block; padding-right: 15px;}

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .card { background: rgba(255,255,255,0.95); border: 1px solid #eee; padding: 25px; transition: 0.2s; position: relative; overflow: hidden; backdrop-filter: blur(5px); }
        .card:hover { border-color: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        h2 { font-size: 10px; color: #999; margin: 0 0 15px 0; letter-spacing: 2px; }

        /* --- BUTTONS --- */
        .btn { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #000; background: #fff; color: #000; font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .btn:hover { background: #000; color: #fff; }
        .btn.black { background: #000; color: #fff; }
        .btn.red { border-color: #E3000F; color: #E3000F; }
        .btn.red:hover { background: #E3000F; color: #fff; }
        .btn.green { border-color: #2ecc71; color: #2ecc71; }
        .btn.green:hover { background: #2ecc71; color: #fff; }

        input, textarea { width: 100%; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; box-sizing: border-box; font-family: sans-serif; font-size: 12px; outline: none; background: rgba(255,255,255,0.9); }
        .flex-row { display: flex; gap: 10px; }
        
        /* NEW NETWORK TABLE */
        table.net-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 12px; margin-top: 15px; }
        table.net-table th { border-bottom: 2px solid #000; padding-bottom: 10px; color: #999; }
        table.net-table td { padding: 12px 0; border-bottom: 1px solid #eee; }

        /* DROPDOWN DETAILS STYLING */
        details.dropdown-card summary { list-style: none; outline: none; cursor: pointer; font-size: 12px; font-weight: 900; letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid transparent; padding-bottom: 5px;}
        details.dropdown-card summary::-webkit-details-marker { display: none; }
        details.dropdown-card[open] summary { border-bottom: 2px solid #1f6feb; margin-bottom: 15px; }
        details.dropdown-card summary:hover { color: #1f6feb; }
    </style>
</head>
<body>

    <canvas id="globe-canvas"></canvas>

    <div id="intro-screen">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>ADMIN INITIALIZING</h1>
        <div id="intro-loader"></div>
        <div id="load-status">Connecting to servers...</div>
        <div style="margin-top: 20px; font-size: 10px; letter-spacing: 2px;">OLIVER TECH HUB v9.0</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h1>SYSTEM ACCESS</h1>
            <input type="text" id="logUser" placeholder="USERNAME">
            <input type="password" id="logPass" placeholder="PASSWORD">
            <button class="login-btn" onclick="checkLogin()">AUTHENTICATE</button>
        </div>
    </div>

    <div class="master-header">
        <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>OLIVER TECH</h1>
    </div>

    <div class="container">
        <div class="target-box">
            <span>COMMAND TARGET:</span>
            <select id="target-screen"><option value="ALL">ALL ACTIVE SCREENS</option></select>
            <button class="btn black" style="width:auto; margin:0;" onclick="sendCommand('toggle_id')">TOGGLE ID TAGS</button>
        </div>

        <div class="section-title">NETWORK DASHBOARD (LIVE)</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <details class="card dropdown-card" style="border: 2px solid #1f6feb;">
                <summary>
                    <span>▼ CONNECTION MENU (CLICK TO EXPAND)</span>
                    <span style="color:#1f6feb;">LIVE</span>
                </summary>
                <table class="net-table">
                    <thead>
                        <tr>
                            <th>SCREEN ID</th>
                            <th>STATUS</th>
                            <th>SERVER PING</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="network-tbody">
                        </tbody>
                </table>
            </details>
        </div>

        <div class="section-title">NUCLEAR CONTROL CENTER</div>
        <div class="grid">
            <div class="card" style="border: 2px solid #2ecc71;">
                <h2>RESETS & CLEARS</h2>
                <button class="btn green" onclick="sendCommand('clear_media')">STOP ALL OVERLAYS</button>
                <button class="btn green" onclick="sendCommand('clear_fx')">REMOVE VISUAL FX</button>
                <button class="btn green" onclick="clearTicker()">REVERT TO DR NEWS</button>
                <button class="btn green" onclick="sendCommand('reset_trains')">NORMALIZE TRAINS</button>
            </div>
            <div class="card" style="border: 2px solid #000;">
                <h2>ID TAG CONTROL</h2>
                <button class="btn black" onclick="sendCommand('show_id')">SHOW ALL ID TAGS</button>
                <button class="btn black" onclick="sendCommand('hide_id')">HIDE ALL ID TAGS</button>
            </div>
            <div class="card" style="border: 2px solid #E3000F;">
                <h2>EMERGENCY STOP</h2>
                <button class="btn red" onclick="sendCommand('blackout')">FORCE BLACKOUT</button>
                <button class="btn red" onclick="sendCommand('reset')">HARD SYSTEM REBOOT</button>
                <button class="btn black" onclick="sendCommand('msg_board', '')">CLOSE ALERT BOX</button>
            </div>
        </div>

        <div class="section-title">INDIVIDUAL TRAIN STATUS</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card">
                <h2>MANUAL ROW OVERRIDE</h2>
                <div class="flex-row" style="align-items: center;">
                    <select id="manual-row-select" style="flex: 1;">
                        <option value="0">1: KØBENHAVN H</option>
                        <option value="1">2: SLIPKØBING</option>
                        <option value="2">3: MODYBY</option>
                        <option value="3">4: SPORLØS</option>
                        <option value="4">5: HJEMBY</option>
                        <option value="5">6: VIRKELIGHEDEN</option>
                    </select>
                    <input type="text" id="manual-msg" placeholder="New Status Text..." style="flex: 2; margin:0;">
                    <select id="manual-color" style="flex: 1;">
                        <option value="white">WHITE</option>
                        <option value="red">RED</option>
                        <option value="yellow">YELLOW</option>
                        <option value="green">GREEN</option>
                    </select>
                    <label style="font-size: 10px; cursor:pointer;"><input type="checkbox" id="manual-blink"> BLINK</label>
                    <button class="btn black" style="width:auto; margin:0;" onclick="sendManualTrain()">UPDATE ROW</button>
                </div>
            </div>
        </div>

        <div class="section-title">GLOBAL SRE CONTROLS</div>
        <div class="grid">
            <div class="card">
                <h2>TICKER & BROADCAST</h2>
                <input type="text" id="tInput" placeholder="Override news feed...">
                <button class="btn black" onclick="sendCommand('ticker', document.getElementById('tInput').value)">SEND HEADLINE</button>
                <button class="btn red" style="margin-top:10px" onclick="sendCommand('status', 'PREMIERE NU')">SET LIVE STATUS</button>
                <button class="btn" onclick="sendCommand('status', 'KLAR')">RESET STATUS</button>
            </div>
            
            <div class="card">
                <h2>GLOBAL TRAIN STATUS</h2>
                <div class="flex-row">
                    <input type="number" id="dInput" placeholder="Min" style="flex:1">
                    <button class="btn red" style="flex:2" onclick="sendCommand('delay', document.getElementById('dInput').value)">DELAY ALL</button>
                </div>
                <button class="btn green" onclick="sendCommand('boarding')">SET ALL TO BOARDING</button>
                <button class="btn red" onclick="cancelAllTrains()">CANCEL ALL TRAINS</button>
            </div>

            <div class="card">
                <h2>EMERGENCY ANNOUNCEMENTS</h2>
                <textarea id="mInput" rows="2" placeholder="Overlay text..."></textarea>
                <button class="btn red" onclick="sendCommand('msg_board', document.getElementById('mInput').value)">SEND FULL SCREEN ALERT</button>
            </div>
        </div>

        <div class="section-title">THE MESS AROUND HACKS</div>
        <div class="grid">
            <div class="card">
                <h2>AI TERMINAL & DVD</h2>
                <textarea id="termInput" rows="3" placeholder="AI text (use \n for lines)..."></textarea>
                <button class="btn black" onclick="sendTerminal()">INJECT TERMINAL</button>
                <button class="btn" onclick="sendCommand('dvd')">DVD BOUNCE MODE</button>
                <button class="btn black" onclick="sendCommand('hacker')">MATRIX OVERLAY</button>
            </div>

            <div class="card">
                <h2>VISUAL CHAOS</h2>
                <div class="flex-row">
                    <button class="btn" onclick="sendCommand('mirror')">MIRROR</button>
                    <button class="btn" onclick="sendCommand('invert')">INVERT</button>
                </div>
                <div class="flex-row">
                    <button class="btn" onclick="sendCommand('shake')">SHAKE</button>
                    <button class="btn" onclick="sendCommand('disco')">DISCO</button>
                </div>
                <button class="btn black" onclick="sendCommand('scramble')">SCRAMBLE BOARD</button>
                <button class="btn" onclick="sendCommand('deepfried')">DEEP FRIED MODE</button>
            </div>

            <div class="card">
                <h2>JUMPSCARES & FAILS</h2>
                <div class="flex-row">
                    <button class="btn red" onclick="sendCommand('roblox')">ROBLOX JUMP</button>
                    <button class="btn red" onclick="sendCommand('meme')">MEME JUMP</button>
                </div>
                <button class="btn red" onclick="sendCommand('bluescreen')">BSOD</button>
                <button class="btn red" onclick="sendCommand('winupdate')">FORCE WIN UPDATE</button>
            </div>
        </div>

        <div class="section-title">SYSTEM ADMINISTRATION</div>
        <div class="grid">
            <div class="card">
                <h2>USER MANAGEMENT</h2>
                <input type="text" id="newU" placeholder="Username">
                <input type="password" id="newP" placeholder="Password">
                <button class="btn black" onclick="addUser()">ADD ADMIN USER</button>
            </div>
            <div class="card">
                <h2>WEATHER OVERRIDE</h2>
                <input type="text" id="wInput" placeholder="Temp/Condition...">
                <button class="btn black" onclick="sendCommand('weather', document.getElementById('wInput').value)">SET GLOBAL WEATHER</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('globe-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeGlobe() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeGlobe);
        resizeGlobe();

        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*".split('');
        const points = [];
        const numPoints = 800; // Density of the globe

        // Generate Fibonacci sphere points
        const phi = Math.PI * (3 - Math.sqrt(5));
        for (let i = 0; i < numPoints; i++) {
            const y = 1 - (i / (numPoints - 1)) * 2;
            const radiusAtY = Math.sqrt(1 - y * y);
            const theta = phi * i;
            
            const x = Math.cos(theta) * radiusAtY;
            const z = Math.sin(theta) * radiusAtY;
            
            points.push({ x, y, z, char: chars[Math.floor(Math.random() * chars.length)] });
        }

        let angle = 0;
        function drawGlobe() {
            ctx.clearRect(0, 0, width, height);
            ctx.font = "14px monospace";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            angle += 0.003; // Rotation speed
            
            const cosA = Math.cos(angle);
            const sinA = Math.sin(angle);
            const projected = [];
            
            for (let i = 0; i < numPoints; i++) {
                const p = points[i];
                // Rotate around Y axis
                const rotX = p.x * cosA - p.z * sinA;
                const rotZ = p.z * cosA + p.x * sinA;
                const rotY = p.y;
                
                const distance = 3;
                const z = rotZ + distance;
                const scale = (Math.min(width, height) * 0.8) / z;
                
                const screenX = width / 2 + rotX * scale;
                const screenY = height / 2 + rotY * scale;
                
                projected.push({screenX, screenY, z: rotZ, char: p.char});
            }
            
            // Sort by depth to draw back to front
            projected.sort((a, b) => b.z - a.z);
            
            for (let i = 0; i < numPoints; i++) {
                const p = projected[i];
                const alpha = (p.z + 1) / 2; // Maps -1 to 1 into 0 to 1
                const opacity = 0.2 + (alpha * 0.8);
                ctx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
                ctx.fillText(p.char, p.screenX, p.screenY);
            }
            requestAnimationFrame(drawGlobe);
        }
        drawGlobe();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://trackless-controller-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Intro Logic
        let introIdx = 0;
        const statusEl = document.getElementById('load-status');
        const introInterval = setInterval(() => { if(introIdx < 4) introIdx++; statusEl.innerText = "Syncing Hub..."; }, 800);
        setTimeout(() => { document.getElementById('intro-screen').style.opacity = '0'; setTimeout(() => document.getElementById('intro-screen').style.display = 'none', 1000); }, 3500);

        // Authentication
        let usersDB = { admin: "1234" };
        onValue(ref(db, 'remote/users'), (snap) => { if(snap.val()) usersDB = snap.val(); });

        window.checkLogin = () => { 
            const u = document.getElementById('logUser').value;
            const p = document.getElementById('logPass').value;
            if (usersDB[u] === p) document.getElementById('login-screen').style.display = 'none'; 
            else alert("ACCESS DENIED"); 
        };

        window.addUser = () => { 
            const u = document.getElementById('newU').value;
            const p = document.getElementById('newP').value;
            if (u && p) { 
                update(ref(db, 'remote/users'), { [u]: p }); 
                alert("USER ADDED"); 
                document.getElementById('newU').value = ""; document.getElementById('newP').value = "";
            } 
        };

        // Command Sender
        window.sendCommand = (event, val = "", overrideTarget = null) => {
            const target = overrideTarget || document.getElementById('target-screen').value;
            update(ref(db, 'remote/commands'), { 
                event: event, 
                value: val, 
                target: target, 
                ts: Date.now() 
            });
        };

        window.sendManualTrain = () => {
            const data = {
                id: document.getElementById('manual-row-select').value,
                msg: document.getElementById('manual-msg').value || "Til Tiden",
                color: document.getElementById('manual-color').value,
                blink: document.getElementById('manual-blink').checked
            };
            window.sendCommand('manual_train', JSON.stringify(data));
        };

        window.cancelAllTrains = () => {
            const rows = [0, 1, 2, 3, 4, 5];
            rows.forEach((rowId, index) => {
                setTimeout(() => {
                    const data = { id: rowId.toString(), msg: "AFLYST", color: "red", blink: true };
                    window.sendCommand('manual_train', JSON.stringify(data));
                }, index * 300);
            });
        };

        window.sendTerminal = () => { 
            window.sendCommand('terminal', document.getElementById('termInput').value || "> SYSTEM OVERRIDE..."); 
            document.getElementById('termInput').value = ""; 
        };

        window.clearTicker = () => { 
            document.getElementById('tInput').value = ""; 
            window.sendCommand('ticker', ""); 
        };

        // LIVE NETWORK MONITORING
        let lastKnownScreens = {};
        
        onValue(ref(db, 'remote/screens'), (snapshot) => {
            lastKnownScreens = snapshot.val() || {};
        });

        function updateNetworkUI() {
            const select = document.getElementById('target-screen');
            const tbody = document.getElementById('network-tbody');
            const current = select.value;
            
            select.innerHTML = '<option value="ALL">ALL ACTIVE SCREENS</option>';
            tbody.innerHTML = '';
            
            const now = Date.now();
            let hasActiveScreens = false;

            Object.keys(lastKnownScreens).forEach(id => {
                const ping = now - lastKnownScreens[id].heartbeat;
                const isOnline = ping < 10000;
                
                if (isOnline) {
                    hasActiveScreens = true;
                    const opt = document.createElement('option');
                    opt.value = id; opt.innerText = id; select.appendChild(opt);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${id}</strong></td>
                    <td style="color: ${isOnline ? '#2ecc71' : '#E3000F'}; font-weight: 900;">${isOnline ? 'ONLINE' : 'OFFLINE'}</td>
                    <td>${isOnline ? ping + ' ms' : 'N/A'}</td>
                    <td>
                        <button class="btn black" style="margin:0; width:auto; padding: 5px 15px;" onclick="sendCommand('kick', '', '${id}')">KICK</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            if (!hasActiveScreens) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color:#999;">NO SCREENS DETECTED</td></tr>';
            }

            if (Array.from(select.options).some(o => o.value === current)) { select.value = current; }
        }

        setInterval(updateNetworkUI, 1000);

    </script>
</body>
</html>