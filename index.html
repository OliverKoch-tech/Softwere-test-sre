<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>SRE Master Hub - OLIVER TECH</title>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <style>
        body { background: #050505; color: white; font-family: Arial, sans-serif; text-transform: uppercase; margin: 0; padding: 20px; overflow: hidden; height: 100vh; transition: transform 0.5s, filter 0.5s; }
        
        /* INTRO & KICK */
        #intro-screen, #kick-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #ffffff; z-index: 9999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 1s ease-in-out; color: #000;
        }
        #intro-screen { cursor: pointer; } 
        #kick-screen { display: none; z-index: 10000000; cursor: not-allowed; }
        
        #intro-screen img, #kick-screen img { max-width: 250px; margin-bottom: 30px; }
        #intro-screen h1, #kick-screen h1 { font-size: 20px; letter-spacing: 5px; margin: 0; font-weight: 900; }
        #kick-screen h1 { color: #E3000F; } 
        .intro-loader { border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px 0; }
        #kick-screen .intro-loader { border-top: 4px solid #E3000F; } 
        .load-status { font-family: monospace; font-size: 14px; color: #666; text-transform: none; font-weight: bold; background: #eee; padding: 10px 20px; border-radius: 5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TROLL EFFECTS */
        .mirror { transform: scaleX(-1); } 
        .upside-down { transform: rotate(180deg); } 
        .glitch-red { animation: panic 0.1s infinite; }
        .deep-fried { filter: contrast(400%) saturate(600%) hue-rotate(320deg); } 
        .disco { animation: disco 0.3s infinite; } 
        .shake { animation: shake 0.4s infinite; }

        @keyframes panic { 0% { background: #050505; } 50% { background: #600; } }
        @keyframes disco { 
            0% { background: #E3000F; } 
            33% { background: #002855; } 
            66% { background: #2ecc71; } 
            100% { background: #FFD700; } 
        }
        @keyframes shake {
            0% { transform: translate(3px, 2px) rotate(0deg); } 
            20% { transform: translate(-3px, -2px) rotate(-1deg); } 
            40% { transform: translate(-3px, 2px) rotate(1deg); } 
            60% { transform: translate(3px, -2px) rotate(0deg); } 
            80% { transform: translate(1px, 2px) rotate(-1deg); } 
            100% { transform: translate(-1px, -2px) rotate(1deg); } 
        }
        
        /* LAYOUT */
        .header { display: flex; justify-content: space-between; border-bottom: 5px solid #E3000F; padding-bottom: 15px; margin-bottom: 20px; align-items: flex-end; }
        .time { color: #FFD700; font-size: 55px; font-weight: bold; line-height: 1; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        table { width: 100%; border-collapse: collapse; } 
        td { padding: 15px 0; border-bottom: 1px solid #1a1a1a; font-size: 32px; font-weight: bold; transition: color 0.2s; }
        .yellow { color: #FFD700; } 
        .red { color: #ff3333; } 
        .white { color: #ffffff; } 
        .green { color: #2ecc71; }
        .ic-box { background: #E3000F; padding: 2px 8px; color: white; border-radius: 3px; } 
        .re-box { background: #002855; padding: 2px 8px; color: white; border-radius: 3px; }
        .blinking { animation: blinker 1s linear infinite; } 
        @keyframes blinker { 50% { opacity: 0; } }
        
        .header-right { text-align: right; display: flex; align-items: center; gap: 25px; }
        .sre-logo { height: 135px; object-fit: contain; }

        /* TICKER */
        .ticker-container { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #002855; color: white; padding: 15px 0; font-size: 24px; font-weight: bold; white-space: nowrap; z-index: 1000; border-top: 2px solid #E3000F;}
        .ticker-text { display: inline-block; padding-left: 100%; animation: ticker 60s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; }
        
        /* SOUNDCLOUD OVERLAY */
        #sc-overlay { background: black; z-index: 99991; overflow: hidden; opacity: 0; transition: opacity 1s ease-in-out; pointer-events: none; }
        #sc-overlay.active { opacity: 1; pointer-events: auto; }
        
        #sc-bg-img { position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; object-fit: cover; filter: blur(40px) brightness(0.3); z-index: 0; display: none; }
        #sc-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .sc-content { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        
        .art-wrapper {
            padding: 2px;
            border-radius: 14px;
            background: #000;
            border: 2px solid #000;
            box-shadow: 0 15px 60px rgba(0,0,0,0.8);
        }

        #sc-art { width: 450px; height: 450px; object-fit: cover; border-radius: 12px; display: block; }
        
        .title-box {
            margin-top: 40px;
            padding: 15px 50px;
            border-radius: 10px;
            background: rgba(10, 10, 10, 0.85);
            border: 2px solid #333;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        #sc-title { font-size: 45px; font-weight: 900; letter-spacing: 5px; text-shadow: 2px 2px 5px rgba(0,0,0,1); text-align: center; max-width: 1200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white;}
        
        #sc-player-container { display: none; }

        /* Legacy Overlays */
        #terminal-overlay { background: rgba(0,0,0,0.95); z-index: 99998; padding: 60px; box-sizing: border-box; }
        #terminal-text { color: #0f0; font-family: monospace; font-size: 45px; white-space: pre-wrap; text-transform: none; text-shadow: 0 0 10px rgba(0,255,0,0.5); line-height: 1.4; }
        #dvd-overlay { background: black; z-index: 99990; overflow: hidden; }
        #dvd-logo { position: absolute; height: 150px; }
        #blackout { background: black; z-index: 99996; } 
        #hacker-matrix { background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 28px; padding: 60px; z-index: 99997; text-transform: none; }
        #jumpscare { z-index: 99998; background-size: contain; background-repeat: no-repeat; background-position: center; background-color: black; }
        #bsod { background: #0000aa; color: white; z-index: 10000; padding: 50px; font-family: monospace; text-transform: none; }
        #win-update { background: #006dae; color: white; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; text-transform: none; text-align: center; }
        #msg-board-overlay { background: rgba(0, 40, 85, 0.98); z-index: 99995; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 50px; border: 20px solid #E3000F; box-sizing:border-box; }
        #msg-board-title { color: #FFD700; font-size: 80px; font-weight: 900; margin-bottom: 30px; letter-spacing: 5px; animation: blinker 2s linear infinite; }
        #screen-id-tag { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #ffffff; padding: 5px 10px; font-size: 12px; font-family: monospace; z-index: 999999; border: 1px solid #444; }
        .footer-logo { position: fixed; bottom: 75px; left: 20px; height: 30px; opacity: 0.3; filter: grayscale(100%); }
    </style>
</head>
<body id="main-body">

    <div id="intro-screen">
        <img src="logo.png" alt="SRE Logo" onerror="this.style.display='none'">
        <h1>SYSTEM INITIALIZING</h1>
        <div class="intro-loader"></div>
        <div id="load-status" class="load-status">CLICK ANYWHERE TO START HUB & UNLOCK AUDIO</div>
    </div>

    <div id="kick-screen">
        <img src="logo.png" alt="SRE Logo" onerror="this.style.display='none'" style="filter: grayscale(100%); opacity: 0.5;">
        <h1>CONNECTION LOST</h1>
        <div class="intro-loader"></div>
        <div class="load-status" style="color: #E3000F; background: transparent;">Connection terminated by Network Administrator.</div>
    </div>

    <div id="sc-overlay" class="overlay">
        <img id="sc-bg-img" src="">
        <canvas id="sc-canvas"></canvas>
        <div class="sc-content">
            <div class="art-wrapper">
                <img id="sc-art" src="">
            </div>
            <div class="title-box">
                <div id="sc-title">FETCHING TRACK...</div>
            </div>
        </div>
        <div id="sc-player-container"></div>
    </div>

    <div id="dvd-overlay" class="overlay"><img id="dvd-logo" src="logo.png"></div>
    <div id="terminal-overlay" class="overlay"><div id="terminal-text"></div></div>
    <div id="screen-id-tag">ID: --</div>
    <div id="msg-board-overlay" class="overlay">
        <div id="msg-board-title">VIGTIG MEDDELELSE</div>
        <div id="msg-board-text" style="font-size:60px; font-weight:bold; color:white; text-transform: none;"></div>
    </div>
    <div id="blackout" class="overlay"></div>
    <div id="hacker-matrix" class="overlay">> SYSTEM COMPROMISED...<br>> INJECTING PAYLOAD...<br>> OVERRIDING SRE MAINFRAME...</div>
    <div id="jumpscare" class="overlay"></div>
    <div id="bsod" class="overlay">
        <h1 style="font-size: 100px;">:(</h1>
        <p style="font-size: 24px;">Din PC løb ind i et problem og skal genstarte...</p>
    </div>
    <div id="win-update" class="overlay">
        <div style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
        <div style="font-size: 32px;">Arbejder på opdateringer... 15% fuldført.<br>Sluk ikke computeren.</div>
    </div>

    <div class="header">
        <div style="font-size: 50px; font-weight: 900;">AFGANGE / DEPARTURES</div>
        <div class="header-right">
            <img src="Srelogo.png" class="sre-logo" alt="SRE Logo" onerror="this.style.display='none'">
            <div style="text-align: right;">
                <div class="time clock-text" id="clock">00:00:00</div>
                <div class="weather-text" style="color: #FFD700; font-size: 20px; font-weight: bold;">HENTER VEJR...</div>
            </div>
        </div>
    </div>
    
    <table>
        <tbody id="train-table"></tbody>
    </table>
    
    <img src="logo.png" class="footer-logo">
    <div class="ticker-container"><div class="ticker-text" id="ticker-msg">HENTER SENESTE NYT FRA DR...</div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getDatabase,
            ref,
            onValue,
            set,
            update,
            get,
            onChildAdded,
            onDisconnect,
            query,
            orderByChild,
            startAt
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://trackless-controller-default-rtdb.europe-west1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // STATE & IDENTITY
        let customTickerActive = false;
        let lastDrNews = "HENTER SENESTE NYT FRA DR...";
        const myId = "SKÆRM-" + Math.floor(Math.random() * 9000 + 1000);
        document.getElementById('screen-id-tag').innerText = "ID: " + myId;
        
        const bootTime = Date.now();
        window.scrambleTimer = null;
        let isKicked = false;
        
        // Media
        let scWidget = null; 
        let trackDuration = 0;
        let progressInterval = null;
        let currentVolume = 80; // 0–100 per screen

        // HEARTBEAT
        const myScreenRef = ref(db, `remote/screens/${myId}`);
        onDisconnect(myScreenRef).remove();
        set(myScreenRef, { heartbeat: Date.now(), status: "ONLINE" });

        setInterval(() => { 
            if (!isKicked) update(myScreenRef, { heartbeat: Date.now() }); 
        }, 3000);

        // INTRO CLICK
        document.getElementById('intro-screen').addEventListener('click', function() {
            this.style.opacity = '0';
            setTimeout(() => this.style.display = 'none', 1000);
        });

        // VISUALIZER
        const scCanvas = document.getElementById('sc-canvas');
        const scCtx = scCanvas.getContext('2d');
        const scBgImg = document.getElementById('sc-bg-img');
        let scAnimFrame;
        let visTime = 0;
        let currentBgMode = 'topo'; 

        const globePoints = [];
        const phi = Math.PI * (3 - Math.sqrt(5));
        const chars = "•×+*".split(''); // node style, like admin

        for (let i = 0; i < 600; i++) {
            const y = 1 - (i / 599) * 2;
            const r = Math.sqrt(1 - y * y);
            const theta = phi * i;
            globePoints.push({ x: Math.cos(theta)*r, y: y, z: Math.sin(theta)*r, char: chars[i % chars.length] });
        }

        function startVisualizer() {
            if (scAnimFrame) cancelAnimationFrame(scAnimFrame);
            
            function draw() {
                scCanvas.width = window.innerWidth;
                scCanvas.height = window.innerHeight;
                scCtx.clearRect(0, 0, scCanvas.width, scCanvas.height);
                visTime += 0.05;

                if (currentBgMode === 'blur') {
                    scCanvas.style.display = 'none';
                    scBgImg.style.display = 'block';
                    scAnimFrame = requestAnimationFrame(draw);
                    return;
                } else {
                    scCanvas.style.display = 'block';
                    scBgImg.style.display = 'none';
                }

                if (currentBgMode === 'topo') {
                    scCtx.font = "14px monospace";
                    scCtx.textAlign = "center";
                    const gridSize = 35, spacing = 1.6; 
                    const angleY = Math.PI / 4, angleX = Math.PI / 3.5; 
                    const cosY = Math.cos(angleY), sinY = Math.sin(angleY);
                    const cosX = Math.cos(angleX), sinX = Math.sin(angleX);
                    const projected = [];

                    for (let x = -gridSize; x <= gridSize; x++) {
                        for (let z = -gridSize; z <= gridSize; z++) {
                            const dist = Math.sqrt(x*x + z*z);
                            let y = Math.sin(dist * 0.25 - visTime) * 2 + Math.cos(x * 0.2 + visTime * 0.8) * 1.5;
                            
                            let px = x * spacing, pz = z * spacing, py = y;
                            let rx = px * cosY - pz * sinY, rz = pz * cosY + px * sinY;
                            let ry = py * cosX - rz * sinX, rz2 = rz * cosX + py * sinX;
                            const zScale = 45 + rz2;
                            if (zScale <= 0) continue;
                            const scale = (Math.min(scCanvas.width, scCanvas.height) * 0.8) / zScale;
                            projected.push({
                                sx: scCanvas.width/2 + rx*scale,
                                sy: scCanvas.height/2 + ry*scale + 100,
                                z: rz2,
                                char: chars[Math.abs(x*z) % chars.length]
                            });
                        }
                    }
                    projected.sort((a,b) => b.z - a.z); 
                    projected.forEach(p => {
                        let alpha = Math.max(0, 1 - (p.z + 20) / 70);
                        scCtx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.7})`;
                        scCtx.fillText(p.char, p.sx, p.sy);
                    });

                } else if (currentBgMode === 'globe') {
                    scCtx.font = "16px monospace";
                    scCtx.textAlign = "center";
                    const cosA = Math.cos(visTime * 0.2), sinA = Math.sin(visTime * 0.2);
                    const projected = [];
                    globePoints.forEach(p => {
                        const rotX = p.x * cosA - p.z * sinA;
                        const rotZ = p.z * cosA + p.x * sinA;
                        const zScale = rotZ + 3;
                        const scale = (Math.min(scCanvas.width, scCanvas.height) * 1.1) / zScale;
                        projected.push({
                            sx: scCanvas.width/2 + rotX*scale,
                            sy: scCanvas.height/2 + p.y*scale,
                            z: rotZ,
                            char: p.char
                        });
                    });
                    projected.sort((a,b) => b.z - a.z);
                    projected.forEach(p => {
                        let alpha = (p.z + 1) / 2;
                        scCtx.fillStyle = `rgba(255, 255, 255, ${0.2 + (alpha * 0.8)})`;
                        scCtx.fillText(p.char, p.sx, p.sy);
                    });
                }
                
                scAnimFrame = requestAnimationFrame(draw);
            }
            draw();
        }

        function stopVisualizer() {
            if (scAnimFrame) cancelAnimationFrame(scAnimFrame);
        }

        // FETCHERS
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=54.91&longitude=11.85&current_weather=true');
                const d = await res.json();
                document.querySelector('.weather-text').innerText =
                    `ØSTER KIPPINGE: ${Math.round(d.current_weather.temperature)}°C`;
            } catch(e) {}
        }
        fetchWeather();
        
        async function fetchNews() {
            try {
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.dr.dk/nyheder/service/feeds/allenyheder');
                const d = await res.json();
                lastDrNews = "+++ SENESTE NYT: " +
                    d.items.slice(0, 8).map(i => i.title.toUpperCase()).join("  +++  ") +
                    " +++";
                if (!customTickerActive) document.getElementById('ticker-msg').innerText = lastDrNews;
            } catch(e) {}
        }
        fetchNews();
        setInterval(fetchNews, 600000);

        // OVERLAY LOGIC
        let dvdInterval, dvdX = 50, dvdY = 50, dvdDx = 4, dvdDy = 4, dvdHue = 0;
        function startDvd() {
            document.getElementById('dvd-overlay').style.display = 'block';
            clearInterval(dvdInterval);
            dvdInterval = setInterval(() => {
                const logo = document.getElementById('dvd-logo');
                if (dvdX + 150 >= window.innerWidth || dvdX <= 0) {
                    dvdDx = -dvdDx;
                    dvdHue = (dvdHue + 75) % 360;
                    logo.style.filter = `invert(30%) sepia(100%) saturate(5000%) hue-rotate(${dvdHue}deg)`;
                }
                if (dvdY + 150 >= window.innerHeight || dvdY <= 0) {
                    dvdDy = -dvdDy;
                    dvdHue = (dvdHue + 75) % 360;
                    logo.style.filter = `invert(30%) sepia(100%) saturate(5000%) hue-rotate(${dvdHue}deg)`;
                }
                dvdX += dvdDx;
                dvdY += dvdDy;
                logo.style.transform = `translate(${dvdX}px, ${dvdY}px)`;
            }, 16);
        }
        function stopDvd() {
            clearInterval(dvdInterval);
            document.getElementById('dvd-overlay').style.display = 'none';
        }

        let typeTimeout;
        function playTerminal(text) {
            document.getElementById('terminal-overlay').style.display = 'block';
            const el = document.getElementById('terminal-text');
            el.innerHTML = '';
            clearTimeout(typeTimeout);
            let i = 0;
            text = text.replace(/\\n/g, '<br>');
            function typeChar() {
                if (i < text.length) {
                    if (text.charAt(i) === '<') {
                        let tag = "";
                        while (text.charAt(i) !== '>' && i < text.length) {
                            tag += text.charAt(i);
                            i++;
                        }
                        tag += '>';
                        el.innerHTML = el.innerHTML.replace('█', '') + tag + '█';
                    } else {
                        el.innerHTML = el.innerHTML.replace('█', '') + text.charAt(i) + '█';
                    }
                    i++;
                    typeTimeout = setTimeout(typeChar, 40);
                }
            }
            typeChar();
        }

        // TRAIN RENDERER
        function renderTrains(trainArray) {
            const tbody = document.getElementById('train-table');
            tbody.innerHTML = '';
            trainArray.forEach((train, index) => {
                const boxClass = (train.type.includes('IC') || train.type === 'SPIL') ? 'ic-box' : 're-box';
                const blinkClass = train.blink ? 'blinking' : '';
                
                const tr = document.createElement('tr');
                tr.id = 'train-' + index;
                tr.innerHTML = `
                    <td class="yellow">${train.time}</td>
                    <td><span class="${boxClass}">${train.type}</span></td>
                    <td class="white">${train.dest}</td>
                    <td class="yellow">${train.track}</td>
                    <td class="${train.color} status-msg ${blinkClass}">${train.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        onValue(ref(db, 'remote/trains'), (snapshot) => {
            if (snapshot.exists()) {
                renderTrains(snapshot.val());
            } else {
                renderTrains([
                    { time: "09:30", type: "IC", dest: "KØBENHAVN H", track: "4", status: "TIL TIDEN", color: "white", blink: false }
                ]);
            }
        });

        // COMMAND LISTENER
        const commandQuery = query(
            ref(db, 'remote/commands'),
            orderByChild('ts'),
            startAt(bootTime)
        );

        onChildAdded(commandQuery, (snapshot) => {
            if (isKicked) return;
            const cmd = snapshot.val();
            if (!cmd) return;
            if (cmd.target !== "ALL" && cmd.target !== myId) return;
            executeCommand(cmd);
        });

        function executeCommand(cmd) {
            const body = document.getElementById('main-body');

            // SYSTEM
            if (cmd.event === "reset") {
                location.reload();
            } else if (cmd.event === "soft_reset") {
                document.querySelectorAll('.overlay').forEach(e => {
                    e.classList.remove('active');
                    setTimeout(() => { if (!e.classList.contains('active')) e.style.display='none'; }, 1000);
                });
                body.classList.remove('mirror', 'upside-down', 'glitch-red', 'disco', 'shake', 'deep-fried');
                if (window.scrambleTimer) {
                    clearInterval(window.scrambleTimer);
                    window.scrambleTimer = null;
                }
                stopDvd();
                stopVisualizer();
                document.getElementById('sc-player-container').innerHTML = ""; 
                clearInterval(progressInterval);
                get(ref(db, 'remote/trains')).then((s) => { if (s.exists()) renderTrains(s.val()); });
            } else if (cmd.event === "kick") {
                isKicked = true;

                document.querySelectorAll('.overlay').forEach(e => {
                    e.classList.remove('active');
                    e.style.display = 'none';
                });
                body.classList.remove('mirror', 'upside-down', 'glitch-red', 'disco', 'shake', 'deep-fried');
                if (window.scrambleTimer) {
                    clearInterval(window.scrambleTimer);
                    window.scrambleTimer = null;
                    document.querySelectorAll('td[data-orig]').forEach(td => {
                        td.innerHTML = td.dataset.orig;
                    });
                }
                stopDvd();
                stopVisualizer();
                document.getElementById('sc-player-container').innerHTML = "";
                clearInterval(progressInterval);

                myScreenRef.remove();

                const kick = document.getElementById('kick-screen');
                kick.style.display = 'flex';
                document.body.style.pointerEvents = 'none';
                kick.style.pointerEvents = 'auto';
            }
            
            // VISUAL FX
            else if (cmd.event === "mirror") {
                body.classList.toggle('mirror');
            } else if (cmd.event === "invert") {
                body.classList.toggle('upside-down');
            } else if (cmd.event === "panic") {
                body.classList.toggle('glitch-red');
            } else if (cmd.event === "disco") {
                body.classList.toggle('disco');
            } else if (cmd.event === "shake") {
                body.classList.toggle('shake');
            } else if (cmd.event === "deepfried") {
                body.classList.toggle('deep-fried');
            } else if (cmd.event === "clear_fx") { 
                body.classList.remove('mirror', 'upside-down', 'glitch-red', 'disco', 'shake', 'deep-fried'); 
                if (window.scrambleTimer) { 
                    clearInterval(window.scrambleTimer);
                    window.scrambleTimer = null; 
                    document.querySelectorAll('td[data-orig]').forEach(td => {
                        td.innerHTML = td.dataset.orig;
                    });
                } 
            } else if (cmd.event === "scramble") {
                if (!window.scrambleTimer) {
                    const tds = document.querySelectorAll('td');
                    tds.forEach(td => { if (!td.dataset.orig) td.dataset.orig = td.innerHTML; });
                    window.scrambleTimer = setInterval(() => {
                        tds.forEach(td => {
                            if (td.querySelector('span')) return;
                            td.innerText = Array.from(td.innerText).map(c =>
                                Math.random() > 0.9 ? "•×+*"[Math.floor(Math.random() * 4)] : c
                            ).join('');
                        });
                    }, 180);
                }
            }

            // OVERLAYS
            else if (cmd.event === "terminal") {
                playTerminal(cmd.value);
            } else if (cmd.event === "dvd") {
                startDvd();
            } else if (cmd.event === "blackout") {
                document.getElementById('blackout').style.display = 'block';
            } else if (cmd.event === "hacker") {
                document.getElementById('hacker-matrix').style.display = 'block';
            } else if (cmd.event === "bluescreen") {
                document.getElementById('bsod').style.display = 'block';
            } else if (cmd.event === "winupdate") {
                document.getElementById('win-update').style.display = 'flex';
            } else if (cmd.event === "roblox") {
                const el = document.getElementById('jumpscare');
                el.style.backgroundImage = "url('roblox.jpg')";
                el.style.display = 'block';
                setTimeout(() => el.style.display='none', 3000);
            } else if (cmd.event === "meme") {
                const el = document.getElementById('jumpscare');
                el.style.backgroundImage = "url('meme.jpg')";
                el.style.display = 'block';
                setTimeout(() => el.style.display='none', 3000);
            } else if (cmd.event === "msg_board") {
                const overlay = document.getElementById('msg-board-overlay');
                if (!cmd.value || cmd.value === "") {
                    overlay.style.display = 'none';
                } else {
                    document.getElementById('msg-board-text').innerHTML = cmd.value;
                    overlay.style.display = 'flex';
                }
            }

            // TEXT / INFO
            else if (cmd.event === "ticker") {
                if (!cmd.value || cmd.value === "") {
                    customTickerActive = false;
                    document.getElementById('ticker-msg').innerText = lastDrNews;
                } else {
                    customTickerActive = true;
                    document.getElementById('ticker-msg').innerText =
                        "*** " + cmd.value.toUpperCase() + " ***";
                }
            } else if (cmd.event === "weather") {
                document.querySelector('.weather-text').innerText = cmd.value;
            } else if (cmd.event === "show_id") {
                document.getElementById('screen-id-tag').style.display = 'block';
            } else if (cmd.event === "hide_id") {
                document.getElementById('screen-id-tag').style.display = 'none';
            } else if (cmd.event === "toggle_id") {
                const tag = document.getElementById('screen-id-tag');
                tag.style.display = (tag.style.display === 'none') ? 'block' : 'none';
            }

            // TRAINS
            else if (cmd.event === "delay") {
                document.querySelectorAll('.status-msg').forEach(el => {
                    el.innerText = "FORSINKET " + (cmd.value || "99") + " MIN";
                    el.className = "red blinking status-msg";
                });
            } else if (cmd.event === "boarding") {
                document.querySelectorAll('.status-msg').forEach(el => {
                    el.innerText = "GÅ TIL SPOR";
                    el.className = "green blinking status-msg";
                });
            } else if (cmd.event === "reset_trains") {
                document.querySelectorAll('.status-msg').forEach(el => {
                    el.innerText = "TIL TIDEN";
                    el.className = "white status-msg";
                });
            }

            // MEDIA
            else if (cmd.event === "sc_pause") {
                try { if (scWidget) scWidget.pause(); } catch(e){}
            } else if (cmd.event === "sc_play") {
                try { if (scWidget) scWidget.play(); } catch(e){}
            } else if (cmd.event === "sc_skip") {
                try { if (scWidget) scWidget.next(); } catch(e){}
            } else if (cmd.event === "sc_shuffle") {
                try { if (scWidget) { scWidget.toggle(); } } catch(e){}
            } else if (cmd.event === "sc_seek") { 
                try { 
                    if (scWidget && trackDuration > 0) {
                        scWidget.seekTo(trackDuration * parseFloat(cmd.value));
                    }
                } catch(e){} 
            } else if (cmd.event === "sc_volume") {
                try {
                    const v = Math.max(0, Math.min(100, parseInt(cmd.value || "80", 10)));
                    currentVolume = v;
                    if (scWidget) scWidget.setVolume(v);
                } catch (e) {}
            } else if (cmd.event === "sc_bg") {
                currentBgMode = cmd.value;
            } else if (cmd.event === "soundcloud") {
                startSoundcloud(cmd.value);
            } else if (cmd.event === "clear_media") {
                clearMedia();
            }
        }

        function startSoundcloud(payloadString) {
            const overlay = document.getElementById('sc-overlay');
            const container = document.getElementById('sc-player-container');
            
            if (!payloadString) {
                clearMedia();
                return;
            }

            let payload;
            try { payload = JSON.parse(payloadString); }
            catch(e) { payload = { url: payloadString }; }

            overlay.style.display = 'block';
            setTimeout(() => overlay.classList.add('active'), 50);
            
            document.getElementById('sc-title').innerText =
                payload.title ? payload.title.toUpperCase() : "LOADING AUDIO...";
            
            if (payload.art) {
                document.getElementById('sc-art').src = payload.art;
                document.getElementById('sc-bg-img').src = payload.art;
            } else {
                document.getElementById('sc-art').src = "";
                document.getElementById('sc-bg-img').src = "";
            }

            startVisualizer();
            
            container.innerHTML = `
                <iframe
                    id="sc-iframe"
                    width="100%"
                    height="166"
                    scrolling="no"
                    frameborder="no"
                    allow="autoplay"
                    src="https://w.soundcloud.com/player/?url=${encodeURIComponent(payload.url)}&color=%23E3000F&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false">
                </iframe>
            `;
            
            setTimeout(() => {
                scWidget = SC.Widget(document.getElementById('sc-iframe'));
                
                scWidget.bind(SC.Widget.Events.PLAY, function() {
                    scWidget.getDuration(function(dur) { trackDuration = dur; });
                    try { scWidget.setVolume(currentVolume); } catch(e){}
                });

                scWidget.bind(SC.Widget.Events.FINISH, function() { scWidget.next(); });

                clearInterval(progressInterval);
                progressInterval = setInterval(() => {
                    if (scWidget) {
                        scWidget.getPosition(function(pos) {
                            set(
                                ref(db, `remote/media_state/${myId}`),
                                {
                                    currentTime: pos,
                                    totalTime: trackDuration,
                                    volume: currentVolume
                                }
                            );
                        });
                    }
                }, 1000);
            }, 500);
        }

        function clearMedia() {
            const overlay = document.getElementById('sc-overlay');
            overlay.classList.remove('active');
            setTimeout(() => {
                if (!overlay.classList.contains('active')) {
                    overlay.style.display='none'; 
                    document.getElementById('sc-player-container').innerHTML = ""; 
                    stopVisualizer();
                    clearInterval(progressInterval);
                    set(
                        ref(db, `remote/media_state/${myId}`),
                        { currentTime: 0, totalTime: 0, volume: currentVolume }
                    );
                }
            }, 1000);
            
            document.querySelectorAll('.overlay').forEach(e => {
                if (e.id !== 'sc-overlay') e.style.display='none';
            }); 
            stopDvd();
        }

        // CLOCK
        setInterval(() => {
            document.getElementById('clock').innerText =
                new Date().toLocaleTimeString('da-DK', {
                    hour:'2-digit',
                    minute:'2-digit',
                    second:'2-digit'
                });
        }, 1000);
    </script>
</body>
</html>